- name: Ensure minimal deps are available
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  become: true
  with_items:
    - dpkg
    - sudo

- name: Ensure kAFL parent directory exists
  ansible.builtin.file:
    path: "{{ kafl_install_root | dirname }}"
    state: directory
    mode: 0775
  when: not ansible_check_mode

- name: Install kAFL system dependencies
  ansible.builtin.package:
    name: "{{ item }}"
  become: true
  with_items:
    - libgraphviz-dev
    - python3-dev
    - python3-venv

- name: Clone repo
  ansible.builtin.git:
    repo: "{{ fuzzer_url }}"
    dest: "{{ fuzzer_root }}"
    version: "{{ fuzzer_revision | default('master') }}"
    depth: "{{ git_clone_depth | default(omit) }}"
    force: "{{ force_clone }}"
  tags:
    - clone

- name: Create venv
  ansible.builtin.command: |
    python3 -m venv .venv
  args:
    chdir: "{{ kafl_install_root }}"
  changed_when: true
  when: not ansible_check_mode

- name: Install kAFL fuzzer
  ansible.builtin.command: |
    .venv/bin/python -m pip install -e "file://{{ fuzzer_root }}"
  args:
    chdir: "{{ kafl_install_root }}"
  changed_when: true
  when: not ansible_check_mode
  tags:
    - build

- name: Install nyx_packer
  ansible.builtin.include_role:
    name: nyx_packer
    public: true
  when: install_nyx_packer

- name: Import post_tasks
  import_tasks: post_tasks.yml
