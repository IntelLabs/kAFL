- name: Import pre_tasks
  import_tasks: pre_tasks.yml

- name: Ensure kAFL parent directory exists
  ansible.builtin.file:
    path: "{{ kafl_install_root | dirname }}"
    state: directory

- name: Install kAFL system dependencies
  ansible.builtin.package:
    name: "{{ item }}"
  become: true
  with_items:
    - libgraphviz-dev
    - python3-dev
    - python3-venv

- name: Clone repo
  ansible.builtin.git:
    repo: "{{ fuzzer_url }}"
    dest: "{{ fuzzer_root }}"
    version: "{{ fuzzer_revision | default('master') }}"
    depth: "{{ git_clone_depth | default(omit) }}"
    force: "{{ force_clone }}"
  tags:
    - clone

- name: Create venv
  ansible.builtin.command: |
    python3 -m venv .venv
  args:
    chdir: "{{ kafl_install_root }}"
  changed_when: true

- name: Install kAFL fuzzer
  ansible.builtin.command: |
    .venv/bin/python -m pip install -e "file://{{ fuzzer_root }}"
  args:
    chdir: "{{ kafl_install_root }}"
  changed_when: true
  tags:
    - build

- name: Import post_tasks
  import_tasks: post_tasks.yml
