- name: Ensure kvm group exists
  group:
    name: kvm
    state: present
  become: yes

- name: Ensure current user is in kvm group
  user:
    name: "{{ ansible_user_id }}"
    groups: kvm
    append: yes
  become: yes

- name: Ensure /dev/kvm has right permissions
  file:
    path: /dev/kvm
    owner: root
    group: kvm
    mode: '0660'
  become: yes
  tags:
    - kvm_device

- name: Update kvm_intel module loading options
  copy:
    dest: /etc/modprobe.d/kafl-kvm-intel.conf
    content: |
      options kvm-intel nested=1 ve_injection=1 halt_on_triple_fault=1
  become: yes

- name: Create .env file
  template:
    src: env.j2
    dest: "{{ kafl_install_root }}/.env"